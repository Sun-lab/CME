
R version 3.1.0 (2014-04-10) -- "Spring Dance"
Copyright (C) 2014 The R Foundation for Statistical Computing
Platform: x86_64-apple-darwin13.1.0 (64-bit)

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> 
> require(gplots)
Loading required package: gplots

Attaching package: ‘gplots’

The following object is masked from ‘package:stats’:

    lowess

Warning message:
package ‘gplots’ was built under R version 3.1.3 
> 
> # ------------------------------------------------------------
> # read in the information of the samples to be used
> # ------------------------------------------------------------
> 
> setwd("~/research/TCGA/_Sun_MethyE/BRCA")
> 
> ff0    = "_data2/patient_brca_female_Caucasian_EMC_info_absolute.txt"
> emInfo = read.table(ff0, sep = "\t", header = TRUE, as.is=TRUE)
> dim(emInfo)
[1] 405  24
> emInfo[1,]
  bcr_patient_barcode patient_id tissue_source_site birth_days_to
1        TCGA-A1-A0SE       A0SE                 A1        -20717
  last_contact_days_to    death_days_to vital_status
1                 1321 [Not Applicable]        Alive
  ajcc_pathologic_tumor_stage tumor_status age_at_diagnosis
1                     Stage I   TUMOR FREE               56
           methylation_barcode
1 TCGA-A1-A0SE-01A-11D-A10P-05
                                                               methylation_file
1 jhu-usc.edu_BRCA.HumanMethylation450.4.lvl-3.TCGA-A1-A0SE-01A-11D-A10P-05.txt
            expression_barcode
1 TCGA-A1-A0SE-01A-11R-A084-07
                                                          expression_file
1 unc.edu.a998e0ce-9248-460f-aabc-2dad452a1ff9.1153763.rsem.genes.results
                    cn_barcode
1 TCGA-A1-A0SE-01A-11D-A087-01
                                                              cn_file abs_call
1 SHAWM_p_TCGAb72_SNP_N_GenomeWideSNP_6_D12_698000.nocnv_hg19.seg.txt   called
  abs_purity abs_ploidy abs_doublings pam50    noHM_PC1     noHM_PC2
1        0.3       4.07             1  LumA 0.008748328 -0.008863467
     noHM_PC3
1 -0.05572216
> 
> # ------------------------------------------------------------
> # read in DNA methylation data
> # ------------------------------------------------------------
> 
> datM = read.table(file = "DNA_Methylation/mValues_tumor_v2.txt", sep = "\t",
+ header = TRUE, as.is=TRUE)
> dim(datM)
[1] 395574    508
> datM[1:2,1:5]
           TCGA.3C.AAAU.01A.11D.A41Q.05 TCGA.4H.AAAK.01A.12D.A41Q.05
cg00000029                     -2.15760                    -1.354920
cg00000165                     -2.22689                    -0.224182
           TCGA.A1.A0SB.01A.11D.A145.05 TCGA.A1.A0SE.01A.11D.A10P.05
cg00000029                     -2.83338                     -1.64876
cg00000165                     -1.86368                     -1.78420
           TCGA.A1.A0SF.01A.11D.A145.05
cg00000029                    -1.627140
cg00000165                    -0.210542
> 
> ss1 = gsub(".", "-", names(datM), fixed=TRUE)
> ss1 = gsub("-TCGA", "/TCGA", ss1, fixed=TRUE)
> 
> table(emInfo$methylation_barcode %in% ss1)

TRUE 
 405 
> 
> datM = datM[,match(emInfo$methylation_barcode, ss1)]
> names(datM) = emInfo$patient_id
> 
> dim(datM)
[1] 395574    405
> datM[1:2,1:5]
               A0SE      A0SF     A0SG      A0SH     A0SI
cg00000029 -1.64876 -1.627140 -1.19139 -2.259350 -1.44617
cg00000165 -1.78420 -0.210542 -2.28357 -0.544723 -1.22358
> 
> # ------------------------------------------------------------
> # remove probes with many NAs and summary mean/sds
> # ------------------------------------------------------------
> 
> nna  = rowSums(is.na(datM))
> summary(nna)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  0.000   0.000   0.000   0.234   0.000  89.000 
> table(nna[nna > 0])

   1    2    3    4    5    6    7    8    9   10   11   12   13   14   15   16 
6369 1771  918  628  500  372  246  247  216  169  142  126  106   92   97   91 
  17   18   19   20   21   22   23   24   25   26   27   28   29   30   31   32 
  80   68   59   67   56   50   47   41   49   44   37   39   39   36   36   29 
  33   34   35   36   37   38   39   40   41   42   43   44   45   46   47   48 
  26   27   27   32   41   24   23   27   27   32   17   18   16   14   16   19 
  49   50   51   52   53   54   55   56   57   58   59   60   61   62   63   64 
  24   18   17   24   17   12   20   11   13   12   16    9   12    4   13   14 
  65   66   67   68   69   70   71   72   73   74   75   76   77   78   79   80 
   8    9   17   10    9    8    1   10    9    8    4    8    6    3    6    4 
  81   82   83   84   85   86   87   89 
   5    3    1    2    1    5    2    1 
> 
> 0.10*ncol(datM)
[1] 40.5
> table(nna < 0.10*ncol(datM))

 FALSE   TRUE 
   535 395039 
> 
> 0.05*ncol(datM)
[1] 20.25
> table(nna < 0.05*ncol(datM))

 FALSE   TRUE 
  1265 394309 
> 
> table(nna < 1)

 FALSE   TRUE 
 13629 381945 
> 
> w2kp = which(nna < 0.05*ncol(datM))
> datM = datM[w2kp,]
> dim(datM)
[1] 394309    405
> datM[1:2,1:5]
               A0SE      A0SF     A0SG      A0SH     A0SI
cg00000029 -1.64876 -1.627140 -1.19139 -2.259350 -1.44617
cg00000165 -1.78420 -0.210542 -2.28357 -0.544723 -1.22358
> 
> avs = rowMeans(datM, na.rm=TRUE)
> sds = apply(datM, 1, sd, na.rm=TRUE)
> 
> summary(sds)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
0.07795 0.37920 0.60590 0.65050 0.85910 2.80900 
> summary(avs)
    Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
-5.05200 -2.59400  0.02491 -0.34480  1.61200  5.14200 
> 
> pdf("figures2/methylation_mvalues.pdf", width=7, height=3.5)
> 
> mat = matrix(c(1,2,3,3), ncol=2)
> layout(mat)
> 
> par(mar=c(5, 4, 1, 1), bty="n")
> hist(avs, xlab="mean values", main="")
> hist(sds, xlab="sds", main="")
> smoothScatter(avs, sds, xlab="mean values", ylab="sds")
> 
> dev.off()
null device 
          1 
> 
> # ------------------------------------------------------------
> # read in DNA methylation information
> # ------------------------------------------------------------
> 
> ff0   = "DNA_Methylation/HM450_info.txt"
> infoM = read.table(ff0, sep = "\t", header = TRUE, as.is=TRUE, comment.char="")
> dim(infoM)
[1] 485577      4
> infoM[1:2,]
  Composite.Element.REF Gene_Symbol Chromosome Genomic_Coordinate
1            cg00000029        RBL2         16           53468112
2            cg00000108     C3orf35          3           37459206
> length(unique(infoM$Composite.Element.REF))
[1] 485577
> 
> table(rownames(datM) %in% infoM$Composite.Element.REF)

  TRUE 
394309 
> 
> infoM = infoM[match(rownames(datM), infoM$Composite.Element.REF),]
> dim(infoM)
[1] 394309      4
> infoM[1:5,]
  Composite.Element.REF Gene_Symbol Chromosome Genomic_Coordinate
1            cg00000029        RBL2         16           53468112
4            cg00000165                      1           91194674
5            cg00000236       VDAC3          8           42263294
6            cg00000289       ACTN1         14           69341139
7            cg00000292      ATP2A1         16           28890100
> 
> table(rownames(datM) == infoM$Composite.Element.REF)

  TRUE 
394309 
> table(infoM$Chromosome, useNA="ifany")

    1    10    11    12    13    14    15    16    17    18    19     2    20 
38242 19826 23592 19786  9777 12319 12483 18028 23465  5021 21102 28054  8658 
   21    22     3     4     5     6     7     8     9     X     Y  <NA> 
 3539  7037 20107 15950 19619 29143 24109 16547  8047  9760    33    65 
> 
> infoM[is.na(infoM$Chromosome),]
       Composite.Element.REF Gene_Symbol Chromosome Genomic_Coordinate
485513            rs10033147        <NA>       <NA>                  0
485514             rs1019916        <NA>       <NA>                  0
485515             rs1040870        <NA>       <NA>                  0
485516            rs10457834        <NA>       <NA>                  0
485517            rs10774834        <NA>       <NA>                  0
485518            rs10796216        <NA>       <NA>                  0
485519            rs10846239        <NA>       <NA>                  0
485520            rs10882854        <NA>       <NA>                  0
485521            rs10936224        <NA>       <NA>                  0
485522            rs11034952        <NA>       <NA>                  0
485523            rs11249206        <NA>       <NA>                  0
485524            rs13369115        <NA>       <NA>                  0
485525              rs133860        <NA>       <NA>                  0
485526             rs1414097        <NA>       <NA>                  0
485527             rs1416770        <NA>       <NA>                  0
485528             rs1467387        <NA>       <NA>                  0
485529             rs1484127        <NA>       <NA>                  0
485530             rs1495031        <NA>       <NA>                  0
485531             rs1510189        <NA>       <NA>                  0
485532             rs1510480        <NA>       <NA>                  0
485533             rs1520670        <NA>       <NA>                  0
485534             rs1941955        <NA>       <NA>                  0
485535             rs1945975        <NA>       <NA>                  0
485536             rs2032088        <NA>       <NA>                  0
485537             rs2125573        <NA>       <NA>                  0
485538              rs213028        <NA>       <NA>                  0
485539             rs2208123        <NA>       <NA>                  0
485540             rs2235751        <NA>       <NA>                  0
485541             rs2385226        <NA>       <NA>                  0
485542             rs2468330        <NA>       <NA>                  0
485543             rs2521373        <NA>       <NA>                  0
485544              rs264581        <NA>       <NA>                  0
485545             rs2804694        <NA>       <NA>                  0
485546             rs2857639        <NA>       <NA>                  0
485547             rs2959823        <NA>       <NA>                  0
485548              rs348937        <NA>       <NA>                  0
485549             rs3818562        <NA>       <NA>                  0
485550             rs3936238        <NA>       <NA>                  0
485551             rs4331560        <NA>       <NA>                  0
485552              rs472920        <NA>       <NA>                  0
485553             rs4742386        <NA>       <NA>                  0
485554             rs5926356        <NA>       <NA>                  0
485555             rs5931272        <NA>       <NA>                  0
485556             rs5936512        <NA>       <NA>                  0
485557             rs5987737        <NA>       <NA>                  0
485558             rs6426327        <NA>       <NA>                  0
485559             rs6471533        <NA>       <NA>                  0
485560              rs654498        <NA>       <NA>                  0
485561             rs6546473        <NA>       <NA>                  0
485562             rs6626309        <NA>       <NA>                  0
485563             rs6982811        <NA>       <NA>                  0
485564             rs6991394        <NA>       <NA>                  0
485565              rs715359        <NA>       <NA>                  0
485566              rs739259        <NA>       <NA>                  0
485567             rs7660805        <NA>       <NA>                  0
485568             rs7746156        <NA>       <NA>                  0
485569              rs798149        <NA>       <NA>                  0
485570              rs845016        <NA>       <NA>                  0
485571              rs877309        <NA>       <NA>                  0
485572             rs9292570        <NA>       <NA>                  0
485573             rs9363764        <NA>       <NA>                  0
485574              rs939290        <NA>       <NA>                  0
485575              rs951295        <NA>       <NA>                  0
485576              rs966367        <NA>       <NA>                  0
485577             rs9839873        <NA>       <NA>                  0
> 
> numChr = infoM$Chromosome
> numChr[infoM$Chromosome=="X"] = "23"
> numChr[infoM$Chromosome=="Y"] = "24"
> numChr = as.numeric(numChr)
> table(numChr)
numChr
    1     2     3     4     5     6     7     8     9    10    11    12    13 
38242 28054 20107 15950 19619 29143 24109 16547  8047 19826 23592 19786  9777 
   14    15    16    17    18    19    20    21    22    23    24 
12319 12483 18028 23465  5021 21102  8658  3539  7037  9760    33 
> 
> od1   = order(numChr, infoM$Genomic_Coordinate)
> datM  = datM[od1,]
> infoM = infoM[od1,]
> 
> # ------------------------------------------------------------
> # plot heatmap of DNA methylation
> # ------------------------------------------------------------
> 
> toplot = data.matrix(exp(datM)/(1 + exp(datM)))
> sds    = apply(toplot, 1, sd, na.rm=TRUE)
> summary(sds)
    Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
0.001256 0.032190 0.096250 0.099950 0.156800 0.374800 
> table(sds > 0.2)

 FALSE   TRUE 
359520  34789 
> table(sds > 0.15)

 FALSE   TRUE 
284070 110239 
> 
> w2kp   = which(sds > 0.2 & !is.na(infoM$Chromosome) & infoM$Chromosome!="Y")
> toplot = toplot[w2kp,]
> infoC  = infoM[w2kp,]
> 
> dim(toplot)
[1] 34721   405
> toplot[1:2,1:5]
                A0SE      A0SF      A0SG      A0SH      A0SI
cg11851804 0.5663791 0.2170451 0.6541818 0.4524687 0.2360930
cg06623778 0.7135344 0.3838759 0.7313534 0.6177741 0.4831212
> 
> dim(infoC)
[1] 34721     4
> infoC[1:2,]
       Composite.Element.REF Gene_Symbol Chromosome Genomic_Coordinate
222107            cg11851804                      1             848379
129147            cg06623778                      1             848409
> 
> table(rownames(toplot) == infoC$Composite.Element.REF)

 TRUE 
34721 
> summary(as.numeric(toplot))
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
  0.004   0.238   0.487   0.480   0.715   0.995    3931 
> 
> png("figures2/methylation_heatmap.png", width = 10, height = 10, units="in", res=400)
> 
> palette.gr.marray = colorRampPalette(c("blue", "white", "red"))
> h2 = heatmap.2(toplot, trace = "none", col = palette.gr.marray,
+               Rowv = T, dendrogram = "both", key = T, symbreaks = F,
+               symkey = F, labRow = NA, labCol = NA, cexCol = 1)
> 
> dev.off()
null device 
          1 
> 
> h2$carpet = NULL
> save(h2, file = "_data2/methylation_cluster.RData")
> 
> # ------------------------------------------------------------
> # plot density of DNA methylation
> # ------------------------------------------------------------
> 
> hc1 = as.hclust(h2$colDendrogram)
> c1  = cutree(hc1, k=6)
> table(names(c1) == colnames(toplot))

TRUE 
 405 
> 
> png("figures2/methylation_density_by_cluster.png", width = 12,
+     height = 8, units="in", res=400)
> par(mfrow=c(2,3), mar=c(5, 4, 1, 1), bty="n")
> cols = rainbow(6)
> for(k in 1:6){
+   plot(c(0,1), c(0,5), type="n", xlab="beta-value", ylab="density", main="")
+   wk = which(c1==k)
+   for(wkj in wk){
+     lines(density(na.omit(toplot[,wkj])), col=cols[k])
+   }
+ }
> 
> dev.off()
null device 
          1 
> 
> # ------------------------------------------------------------
> # Run PCA using methylation data, check possible outlier
> # these PCs do include many batch effect information
> # ------------------------------------------------------------
> 
> datM     = data.matrix(datM)
> datR14Pr = datM - rowMeans(datM, na.rm=TRUE)
> 
> datR14Pr[is.na(datR14Pr)] = 0
> covdatR1 = t(datR14Pr) %*% datR14Pr / nrow(datR14Pr)
> dim(covdatR1)
[1] 405 405
> prdatR1  = eigen(covdatR1)
> 
> prdatR1$values[1:20]
 [1] 28.032826 21.100766 10.153128  7.498112  6.413307  5.910010  4.497437
 [8]  3.392443  2.749554  2.686554  2.400847  1.954515  1.853882  1.594548
[15]  1.500805  1.436955  1.353393  1.307963  1.261904  1.209821
> 
> PC1 =  prdatR1$vectors[,1]
> PC2 =  prdatR1$vectors[,2]
> PC3 =  prdatR1$vectors[,3]
> 
> pdf("figures2/methylation_PCs_mvalue.pdf", width=6, height=6)
> par(mar=c(5,4,1,1), mfrow=c(2,2))
> barplot(prdatR1$values[1:20], main="",
+ xlab="Index", ylab="Eigen-value")
> 
> par(mar=c(5,4,1,1))
> subtypes = unique(na.omit(emInfo$pam50))
> cols = c("red", "green", "blue", "purple", "orange")
> 
> legend("topright", legend=subtypes, col=cols, pch=1, bty="n")
> 
> plot(PC1, PC2,  bty="n", cex=0.8)
> for(j in 1:5){
+   sj = subtypes[j]
+   wj = which(emInfo$pam50 == sj)
+   points(PC1[wj], PC2[wj], col=cols[j], cex=0.8)
+ }
> 
> plot(PC1, PC3,  bty="n", cex=0.8)
> for(j in 1:5){
+   sj = subtypes[j]
+   wj = which(emInfo$pam50 == sj)
+   points(PC1[wj], PC3[wj], col=cols[j], cex=0.8)
+ }
> 
> plot(PC2, PC3,  bty="n", cex=0.8)
> for(j in 1:5){
+   sj = subtypes[j]
+   wj = which(emInfo$pam50 == sj)
+   points(PC2[wj], PC3[wj], col=cols[j], cex=0.8)
+ }
> 
> dev.off()
null device 
          1 
> 
> cor(prdatR1$vectors[,1:5], emInfo$absolute_extract_purity, use="pair")
              [,1]          [,2]          [,3]          [,4]          [,5]
[1,]  1.000000e+00  8.409754e-16 -1.884083e-16  6.931818e-17 -2.069833e-16
[2,]  8.409754e-16  1.000000e+00  8.026496e-16 -2.993031e-16  2.697871e-16
[3,] -1.884083e-16  8.026496e-16  1.000000e+00 -2.668410e-16  1.581993e-16
[4,]  6.931818e-17 -2.993031e-16 -2.668410e-16  1.000000e+00  4.594938e-17
[5,] -2.069833e-16  2.697871e-16  1.581993e-16  4.594938e-17  1.000000e+00
> cor(prdatR1$vectors[,1:5], emInfo$age_at_diagnosis, use="pair")
            [,1]
[1,]  0.15256315
[2,] -0.20083928
[3,] -0.03797190
[4,]  0.04951605
[5,] -0.09665590
> 
> summary(lm(PC1 ~ emInfo$pam50))

Call:
lm(formula = PC1 ~ emInfo$pam50)

Residuals:
      Min        1Q    Median        3Q       Max 
-0.130994 -0.028884  0.000734  0.028281  0.175017 

Coefficients:
                    Estimate Std. Error t value Pr(>|t|)    
(Intercept)        -0.037777   0.005901  -6.402 4.30e-10 ***
emInfo$pam50Her2    0.040042   0.011801   3.393  0.00076 ***
emInfo$pam50LumA    0.043432   0.006686   6.496 2.45e-10 ***
emInfo$pam50LumB    0.052151   0.007676   6.794 3.97e-11 ***
emInfo$pam50Normal  0.008886   0.017579   0.505  0.61350    
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 0.04683 on 400 degrees of freedom
Multiple R-squared:  0.1226,	Adjusted R-squared:  0.1138 
F-statistic: 13.97 on 4 and 400 DF,  p-value: 1.114e-10

> summary(lm(PC2 ~ emInfo$pam50))

Call:
lm(formula = PC2 ~ emInfo$pam50)

Residuals:
      Min        1Q    Median        3Q       Max 
-0.135737 -0.023866  0.003983  0.026818  0.099829 

Coefficients:
                    Estimate Std. Error t value Pr(>|t|)    
(Intercept)         0.069202   0.004755  14.553  < 2e-16 ***
emInfo$pam50Her2   -0.050903   0.009511  -5.352 1.47e-07 ***
emInfo$pam50LumA   -0.080132   0.005388 -14.873  < 2e-16 ***
emInfo$pam50LumB   -0.098619   0.006186 -15.942  < 2e-16 ***
emInfo$pam50Normal -0.024263   0.014166  -1.713   0.0875 .  
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 0.03774 on 400 degrees of freedom
Multiple R-squared:  0.4302,	Adjusted R-squared:  0.4245 
F-statistic: 75.49 on 4 and 400 DF,  p-value: < 2.2e-16

> summary(lm(PC3 ~ emInfo$pam50))

Call:
lm(formula = PC3 ~ emInfo$pam50)

Residuals:
      Min        1Q    Median        3Q       Max 
-0.121084 -0.032112  0.000692  0.030392  0.130429 

Coefficients:
                    Estimate Std. Error t value Pr(>|t|)    
(Intercept)        -0.019649   0.005857  -3.355  0.00087 ***
emInfo$pam50Her2   -0.019953   0.011714  -1.703  0.08928 .  
emInfo$pam50LumA    0.035593   0.006636   5.363 1.38e-07 ***
emInfo$pam50LumB    0.004892   0.007619   0.642  0.52122    
emInfo$pam50Normal  0.003791   0.017449   0.217  0.82811    
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 0.04649 on 400 degrees of freedom
Multiple R-squared:  0.1355,	Adjusted R-squared:  0.1269 
F-statistic: 15.68 on 4 and 400 DF,  p-value: 6.306e-12

> 
> # ------------------------------------------------------------
> # write out data and information
> # ------------------------------------------------------------
> 
> table(colnames(datM) == emInfo$patient_id)

TRUE 
 405 
> 
> pDat = data.frame(id=rownames(datM), datM)
> dim(pDat)
[1] 394309    406
> pDat[1:2,1:5]
                   id     A0SE     A0SF     A0SG     A0SH
cg13869341 cg13869341 1.992940 2.569750 1.868150 2.305290
cg14008030 cg14008030 0.602427 0.429316 0.250666 0.437007
> 
> write.table(pDat, file = "_data2/methylation_mvalue.txt", append = FALSE,
+             quote = FALSE, sep = "\t", row.names = FALSE, col.names = TRUE)
> 
> dim(infoM)
[1] 394309      4
> infoM[1:5,]
       Composite.Element.REF Gene_Symbol Chromosome Genomic_Coordinate
256613            cg13869341      WASH5P          1              15865
259523            cg14008030      WASH5P          1              18827
225317            cg12045430      WASH5P          1              29407
372829            cg20826792      WASH5P          1              29425
8076              cg00381604      WASH5P          1              29435
> 
> write.table(infoM, file = "_data2/methylation_info.txt", append = FALSE,
+             quote = FALSE, sep = "\t", row.names = FALSE, col.names = TRUE)
> 
> # ------------------------------------------------------------
> # check the association between DNA methylation and batches
> # ------------------------------------------------------------
> 
> samM = strsplit(emInfo$methylation_file, split="-", fixed=TRUE)
> table(sapply(samM, length))

  9 
405 
> samM = matrix(unlist(samM), byrow=TRUE, ncol=9)
> dim(samM)
[1] 405   9
> samM[1:2,]
     [,1]  [,2]                                      [,3]     [,4] [,5]   [,6] 
[1,] "jhu" "usc.edu_BRCA.HumanMethylation450.4.lvl"  "3.TCGA" "A1" "A0SE" "01A"
[2,] "jhu" "usc.edu_BRCA.HumanMethylation450.11.lvl" "3.TCGA" "A1" "A0SF" "01A"
     [,7]  [,8]   [,9]    
[1,] "11D" "A10P" "05.txt"
[2,] "11D" "A145" "05.txt"
> 
> samM = samM[,4:8]
> dim(samM)
[1] 405   5
> samM[1:2,]
     [,1] [,2]   [,3]  [,4]  [,5]  
[1,] "A1" "A0SE" "01A" "11D" "A10P"
[2,] "A1" "A0SF" "01A" "11D" "A145"
> 
> samM = data.frame(samM, stringsAsFactors=FALSE)
> names(samM) = c("institution", "patientID", "type", "portion", "plate")
> dim(samM)
[1] 405   5
> samM[1:2,]
  institution patientID type portion plate
1          A1      A0SE  01A     11D  A10P
2          A1      A0SF  01A     11D  A145
> 
> table(rowSums(is.na(datM)))

     0      1      2      3      4      5      6      7      8      9     10 
381945   6369   1771    918    628    500    372    246    247    216    169 
    11     12     13     14     15     16     17     18     19     20 
   142    126    106     92     97     91     80     68     59     67 
> 
> pM    = matrix(NA, nrow=nrow(datM), ncol=6)
> rDatM = matrix(NA, nrow=nrow(datM), ncol=ncol(datM))
> age   = emInfo$age_at_diagnosis
> PC1   = emInfo$noHM_PC1
> PC2   = emInfo$noHM_PC2
> PC3   = emInfo$noHM_PC3
> 
> for(i in 1:nrow(datM)){
+   
+   if(i %% 1000 == 0){
+     cat(i, date(), "\n")
+   }
+   
+   yi = datM[i,]
+   li = lm(yi ~ samM$institution + samM$plate + age + PC1 + PC2 + PC3)
+   ai = anova(li)
+   
+   pM[i,] = ai[1:6,5]
+ 
+   rDatM[i,which(!is.na(yi))] = li$residuals
+ }
1000 Tue Aug 11 01:52:06 2015 
2000 Tue Aug 11 01:52:12 2015 
3000 Tue Aug 11 01:52:17 2015 
4000 Tue Aug 11 01:52:22 2015 
5000 Tue Aug 11 01:52:27 2015 
6000 Tue Aug 11 01:52:33 2015 
7000 Tue Aug 11 01:52:38 2015 
8000 Tue Aug 11 01:52:44 2015 
9000 Tue Aug 11 01:52:49 2015 
10000 Tue Aug 11 01:52:54 2015 
11000 Tue Aug 11 01:52:59 2015 
12000 Tue Aug 11 01:53:04 2015 
13000 Tue Aug 11 01:53:10 2015 
14000 Tue Aug 11 01:53:15 2015 
15000 Tue Aug 11 01:53:20 2015 
16000 Tue Aug 11 01:53:25 2015 
17000 Tue Aug 11 01:53:30 2015 
18000 Tue Aug 11 01:53:35 2015 
19000 Tue Aug 11 01:53:40 2015 
20000 Tue Aug 11 01:53:45 2015 
21000 Tue Aug 11 01:53:50 2015 
22000 Tue Aug 11 01:53:56 2015 
23000 Tue Aug 11 01:54:01 2015 
24000 Tue Aug 11 01:54:07 2015 
25000 Tue Aug 11 01:54:12 2015 
26000 Tue Aug 11 01:54:17 2015 
27000 Tue Aug 11 01:54:22 2015 
28000 Tue Aug 11 01:54:26 2015 
29000 Tue Aug 11 01:54:32 2015 
30000 Tue Aug 11 01:54:37 2015 
31000 Tue Aug 11 01:54:42 2015 
32000 Tue Aug 11 01:54:47 2015 
33000 Tue Aug 11 01:54:53 2015 
34000 Tue Aug 11 01:54:58 2015 
35000 Tue Aug 11 01:55:03 2015 
36000 Tue Aug 11 01:55:08 2015 
37000 Tue Aug 11 01:55:13 2015 
38000 Tue Aug 11 01:55:18 2015 
39000 Tue Aug 11 01:55:23 2015 
40000 Tue Aug 11 01:55:28 2015 
41000 Tue Aug 11 01:55:33 2015 
42000 Tue Aug 11 01:55:38 2015 
43000 Tue Aug 11 01:55:43 2015 
44000 Tue Aug 11 01:55:48 2015 
45000 Tue Aug 11 01:55:53 2015 
46000 Tue Aug 11 01:55:58 2015 
47000 Tue Aug 11 01:56:03 2015 
48000 Tue Aug 11 01:56:09 2015 
49000 Tue Aug 11 01:56:14 2015 
50000 Tue Aug 11 01:56:19 2015 
51000 Tue Aug 11 01:56:24 2015 
52000 Tue Aug 11 01:56:29 2015 
53000 Tue Aug 11 01:56:34 2015 
54000 Tue Aug 11 01:56:40 2015 
55000 Tue Aug 11 01:56:45 2015 
56000 Tue Aug 11 01:56:50 2015 
57000 Tue Aug 11 01:56:55 2015 
58000 Tue Aug 11 01:57:01 2015 
59000 Tue Aug 11 01:57:06 2015 
60000 Tue Aug 11 01:57:12 2015 
61000 Tue Aug 11 01:57:18 2015 
62000 Tue Aug 11 01:57:23 2015 
63000 Tue Aug 11 01:57:28 2015 
64000 Tue Aug 11 01:57:34 2015 
65000 Tue Aug 11 01:57:39 2015 
66000 Tue Aug 11 01:57:45 2015 
67000 Tue Aug 11 01:57:50 2015 
68000 Tue Aug 11 01:57:54 2015 
69000 Tue Aug 11 01:57:59 2015 
70000 Tue Aug 11 01:58:04 2015 
71000 Tue Aug 11 01:58:09 2015 
72000 Tue Aug 11 01:58:14 2015 
73000 Tue Aug 11 01:58:20 2015 
74000 Tue Aug 11 01:58:25 2015 
75000 Tue Aug 11 01:58:30 2015 
76000 Tue Aug 11 01:58:36 2015 
77000 Tue Aug 11 01:58:41 2015 
78000 Tue Aug 11 01:58:46 2015 
79000 Tue Aug 11 01:58:51 2015 
80000 Tue Aug 11 01:58:57 2015 
81000 Tue Aug 11 01:59:02 2015 
82000 Tue Aug 11 01:59:07 2015 
83000 Tue Aug 11 01:59:13 2015 
84000 Tue Aug 11 01:59:18 2015 
85000 Tue Aug 11 01:59:23 2015 
86000 Tue Aug 11 01:59:29 2015 
87000 Tue Aug 11 01:59:34 2015 
88000 Tue Aug 11 01:59:39 2015 
89000 Tue Aug 11 01:59:45 2015 
90000 Tue Aug 11 01:59:50 2015 
91000 Tue Aug 11 01:59:55 2015 
92000 Tue Aug 11 02:00:01 2015 
93000 Tue Aug 11 02:00:06 2015 
94000 Tue Aug 11 02:00:12 2015 
95000 Tue Aug 11 02:00:17 2015 
96000 Tue Aug 11 02:00:23 2015 
97000 Tue Aug 11 02:00:28 2015 
98000 Tue Aug 11 02:00:34 2015 
99000 Tue Aug 11 02:00:39 2015 
100000 Tue Aug 11 02:00:45 2015 
101000 Tue Aug 11 02:00:50 2015 
102000 Tue Aug 11 02:00:56 2015 
103000 Tue Aug 11 02:01:01 2015 
104000 Tue Aug 11 02:01:06 2015 
105000 Tue Aug 11 02:01:11 2015 
106000 Tue Aug 11 02:01:16 2015 
107000 Tue Aug 11 02:01:21 2015 
108000 Tue Aug 11 02:01:26 2015 
109000 Tue Aug 11 02:01:31 2015 
110000 Tue Aug 11 02:01:37 2015 
111000 Tue Aug 11 02:01:42 2015 
112000 Tue Aug 11 02:01:47 2015 
113000 Tue Aug 11 02:01:52 2015 
114000 Tue Aug 11 02:01:57 2015 
115000 Tue Aug 11 02:02:02 2015 
116000 Tue Aug 11 02:02:07 2015 
117000 Tue Aug 11 02:02:12 2015 
118000 Tue Aug 11 02:02:17 2015 
119000 Tue Aug 11 02:02:22 2015 
120000 Tue Aug 11 02:02:26 2015 
121000 Tue Aug 11 02:02:32 2015 
122000 Tue Aug 11 02:02:37 2015 
123000 Tue Aug 11 02:02:42 2015 
124000 Tue Aug 11 02:02:47 2015 
125000 Tue Aug 11 02:02:52 2015 
126000 Tue Aug 11 02:02:57 2015 
127000 Tue Aug 11 02:03:02 2015 
128000 Tue Aug 11 02:03:07 2015 
129000 Tue Aug 11 02:03:12 2015 
130000 Tue Aug 11 02:03:17 2015 
131000 Tue Aug 11 02:03:22 2015 
132000 Tue Aug 11 02:03:27 2015 
133000 Tue Aug 11 02:03:32 2015 
134000 Tue Aug 11 02:03:37 2015 
135000 Tue Aug 11 02:03:42 2015 
136000 Tue Aug 11 02:03:47 2015 
137000 Tue Aug 11 02:03:52 2015 
138000 Tue Aug 11 02:03:57 2015 
139000 Tue Aug 11 02:04:02 2015 
140000 Tue Aug 11 02:04:07 2015 
141000 Tue Aug 11 02:04:12 2015 
142000 Tue Aug 11 02:04:17 2015 
143000 Tue Aug 11 02:04:22 2015 
144000 Tue Aug 11 02:04:28 2015 
145000 Tue Aug 11 02:04:33 2015 
146000 Tue Aug 11 02:04:39 2015 
147000 Tue Aug 11 02:04:44 2015 
148000 Tue Aug 11 02:04:49 2015 
149000 Tue Aug 11 02:04:54 2015 
150000 Tue Aug 11 02:04:59 2015 
151000 Tue Aug 11 02:05:04 2015 
152000 Tue Aug 11 02:05:09 2015 
153000 Tue Aug 11 02:05:14 2015 
154000 Tue Aug 11 02:05:19 2015 
155000 Tue Aug 11 02:05:24 2015 
156000 Tue Aug 11 02:05:29 2015 
157000 Tue Aug 11 02:05:35 2015 
158000 Tue Aug 11 02:05:40 2015 
159000 Tue Aug 11 02:05:45 2015 
160000 Tue Aug 11 02:05:51 2015 
161000 Tue Aug 11 02:05:56 2015 
162000 Tue Aug 11 02:06:01 2015 
163000 Tue Aug 11 02:06:06 2015 
164000 Tue Aug 11 02:06:12 2015 
165000 Tue Aug 11 02:06:17 2015 
166000 Tue Aug 11 02:06:22 2015 
167000 Tue Aug 11 02:06:27 2015 
168000 Tue Aug 11 02:06:32 2015 
169000 Tue Aug 11 02:06:37 2015 
170000 Tue Aug 11 02:06:42 2015 
171000 Tue Aug 11 02:06:47 2015 
172000 Tue Aug 11 02:06:53 2015 
173000 Tue Aug 11 02:06:58 2015 
174000 Tue Aug 11 02:07:02 2015 
175000 Tue Aug 11 02:07:07 2015 
176000 Tue Aug 11 02:07:12 2015 
177000 Tue Aug 11 02:07:17 2015 
178000 Tue Aug 11 02:07:23 2015 
179000 Tue Aug 11 02:07:28 2015 
180000 Tue Aug 11 02:07:33 2015 
181000 Tue Aug 11 02:07:39 2015 
182000 Tue Aug 11 02:07:44 2015 
183000 Tue Aug 11 02:07:50 2015 
184000 Tue Aug 11 02:07:55 2015 
185000 Tue Aug 11 02:08:00 2015 
186000 Tue Aug 11 02:08:06 2015 
187000 Tue Aug 11 02:08:11 2015 
188000 Tue Aug 11 02:08:17 2015 
189000 Tue Aug 11 02:08:22 2015 
190000 Tue Aug 11 02:08:27 2015 
191000 Tue Aug 11 02:08:33 2015 
192000 Tue Aug 11 02:08:38 2015 
193000 Tue Aug 11 02:08:43 2015 
194000 Tue Aug 11 02:08:49 2015 
195000 Tue Aug 11 02:08:54 2015 
196000 Tue Aug 11 02:09:00 2015 
197000 Tue Aug 11 02:09:05 2015 
198000 Tue Aug 11 02:09:10 2015 
199000 Tue Aug 11 02:09:15 2015 
200000 Tue Aug 11 02:09:20 2015 
201000 Tue Aug 11 02:09:25 2015 
202000 Tue Aug 11 02:09:30 2015 
203000 Tue Aug 11 02:09:35 2015 
204000 Tue Aug 11 02:09:41 2015 
205000 Tue Aug 11 02:09:46 2015 
206000 Tue Aug 11 02:09:51 2015 
207000 Tue Aug 11 02:09:56 2015 
208000 Tue Aug 11 02:10:02 2015 
209000 Tue Aug 11 02:10:07 2015 
210000 Tue Aug 11 02:10:13 2015 
211000 Tue Aug 11 02:10:18 2015 
212000 Tue Aug 11 02:10:24 2015 
213000 Tue Aug 11 02:10:29 2015 
214000 Tue Aug 11 02:10:35 2015 
215000 Tue Aug 11 02:10:40 2015 
216000 Tue Aug 11 02:10:46 2015 
217000 Tue Aug 11 02:10:51 2015 
218000 Tue Aug 11 02:10:56 2015 
219000 Tue Aug 11 02:11:01 2015 
220000 Tue Aug 11 02:11:07 2015 
221000 Tue Aug 11 02:11:12 2015 
222000 Tue Aug 11 02:11:17 2015 
223000 Tue Aug 11 02:11:23 2015 
224000 Tue Aug 11 02:11:28 2015 
225000 Tue Aug 11 02:11:33 2015 
226000 Tue Aug 11 02:11:39 2015 
227000 Tue Aug 11 02:11:44 2015 
228000 Tue Aug 11 02:11:49 2015 
229000 Tue Aug 11 02:11:54 2015 
230000 Tue Aug 11 02:12:00 2015 
231000 Tue Aug 11 02:12:05 2015 
232000 Tue Aug 11 02:12:11 2015 
233000 Tue Aug 11 02:12:16 2015 
234000 Tue Aug 11 02:12:21 2015 
235000 Tue Aug 11 02:12:27 2015 
236000 Tue Aug 11 02:12:33 2015 
237000 Tue Aug 11 02:12:39 2015 
238000 Tue Aug 11 02:12:44 2015 
239000 Tue Aug 11 02:12:49 2015 
240000 Tue Aug 11 02:12:55 2015 
241000 Tue Aug 11 02:13:00 2015 
242000 Tue Aug 11 02:13:06 2015 
243000 Tue Aug 11 02:13:11 2015 
244000 Tue Aug 11 02:13:16 2015 
245000 Tue Aug 11 02:13:21 2015 
246000 Tue Aug 11 02:13:27 2015 
247000 Tue Aug 11 02:13:32 2015 
248000 Tue Aug 11 02:13:38 2015 
249000 Tue Aug 11 02:13:43 2015 
250000 Tue Aug 11 02:13:49 2015 
251000 Tue Aug 11 02:13:54 2015 
252000 Tue Aug 11 02:14:00 2015 
253000 Tue Aug 11 02:14:05 2015 
254000 Tue Aug 11 02:14:10 2015 
255000 Tue Aug 11 02:14:16 2015 
256000 Tue Aug 11 02:14:21 2015 
257000 Tue Aug 11 02:14:27 2015 
258000 Tue Aug 11 02:14:32 2015 
259000 Tue Aug 11 02:14:37 2015 
260000 Tue Aug 11 02:14:43 2015 
261000 Tue Aug 11 02:14:48 2015 
262000 Tue Aug 11 02:14:54 2015 
263000 Tue Aug 11 02:14:59 2015 
264000 Tue Aug 11 02:15:05 2015 
265000 Tue Aug 11 02:15:10 2015 
266000 Tue Aug 11 02:15:15 2015 
267000 Tue Aug 11 02:15:21 2015 
268000 Tue Aug 11 02:15:26 2015 
269000 Tue Aug 11 02:15:32 2015 
270000 Tue Aug 11 02:15:38 2015 
271000 Tue Aug 11 02:15:43 2015 
272000 Tue Aug 11 02:15:49 2015 
273000 Tue Aug 11 02:15:54 2015 
274000 Tue Aug 11 02:15:59 2015 
275000 Tue Aug 11 02:16:05 2015 
276000 Tue Aug 11 02:16:10 2015 
277000 Tue Aug 11 02:16:15 2015 
278000 Tue Aug 11 02:16:20 2015 
279000 Tue Aug 11 02:16:25 2015 
280000 Tue Aug 11 02:16:30 2015 
281000 Tue Aug 11 02:16:36 2015 
282000 Tue Aug 11 02:16:41 2015 
283000 Tue Aug 11 02:16:47 2015 
284000 Tue Aug 11 02:16:52 2015 
285000 Tue Aug 11 02:16:58 2015 
286000 Tue Aug 11 02:17:04 2015 
287000 Tue Aug 11 02:17:09 2015 
288000 Tue Aug 11 02:17:15 2015 
289000 Tue Aug 11 02:17:21 2015 
290000 Tue Aug 11 02:17:26 2015 
291000 Tue Aug 11 02:17:31 2015 
292000 Tue Aug 11 02:17:37 2015 
293000 Tue Aug 11 02:17:43 2015 
294000 Tue Aug 11 02:17:48 2015 
295000 Tue Aug 11 02:17:54 2015 
296000 Tue Aug 11 02:17:59 2015 
297000 Tue Aug 11 02:18:04 2015 
298000 Tue Aug 11 02:18:10 2015 
299000 Tue Aug 11 02:18:15 2015 
300000 Tue Aug 11 02:18:20 2015 
301000 Tue Aug 11 02:18:25 2015 
302000 Tue Aug 11 02:18:30 2015 
303000 Tue Aug 11 02:18:35 2015 
304000 Tue Aug 11 02:18:40 2015 
305000 Tue Aug 11 02:18:46 2015 
306000 Tue Aug 11 02:18:51 2015 
307000 Tue Aug 11 02:18:56 2015 
308000 Tue Aug 11 02:19:01 2015 
309000 Tue Aug 11 02:19:06 2015 
310000 Tue Aug 11 02:19:11 2015 
311000 Tue Aug 11 02:19:16 2015 
312000 Tue Aug 11 02:19:21 2015 
313000 Tue Aug 11 02:19:26 2015 
314000 Tue Aug 11 02:19:31 2015 
315000 Tue Aug 11 02:19:36 2015 
316000 Tue Aug 11 02:19:42 2015 
317000 Tue Aug 11 02:19:47 2015 
318000 Tue Aug 11 02:19:52 2015 
319000 Tue Aug 11 02:19:57 2015 
320000 Tue Aug 11 02:20:02 2015 
321000 Tue Aug 11 02:20:07 2015 
322000 Tue Aug 11 02:20:13 2015 
323000 Tue Aug 11 02:20:18 2015 
324000 Tue Aug 11 02:20:24 2015 
325000 Tue Aug 11 02:20:29 2015 
326000 Tue Aug 11 02:20:34 2015 
327000 Tue Aug 11 02:20:40 2015 
328000 Tue Aug 11 02:20:45 2015 
329000 Tue Aug 11 02:20:50 2015 
330000 Tue Aug 11 02:20:56 2015 
331000 Tue Aug 11 02:21:01 2015 
332000 Tue Aug 11 02:21:07 2015 
333000 Tue Aug 11 02:21:13 2015 
334000 Tue Aug 11 02:21:18 2015 
335000 Tue Aug 11 02:21:24 2015 
336000 Tue Aug 11 02:21:30 2015 
337000 Tue Aug 11 02:21:35 2015 
338000 Tue Aug 11 02:21:40 2015 
339000 Tue Aug 11 02:21:46 2015 
340000 Tue Aug 11 02:21:51 2015 
341000 Tue Aug 11 02:21:56 2015 
342000 Tue Aug 11 02:22:01 2015 
343000 Tue Aug 11 02:22:06 2015 
344000 Tue Aug 11 02:22:11 2015 
345000 Tue Aug 11 02:22:16 2015 
346000 Tue Aug 11 02:22:22 2015 
347000 Tue Aug 11 02:22:27 2015 
348000 Tue Aug 11 02:22:32 2015 
349000 Tue Aug 11 02:22:37 2015 
350000 Tue Aug 11 02:22:43 2015 
351000 Tue Aug 11 02:22:48 2015 
352000 Tue Aug 11 02:22:53 2015 
353000 Tue Aug 11 02:22:58 2015 
354000 Tue Aug 11 02:23:03 2015 
355000 Tue Aug 11 02:23:09 2015 
356000 Tue Aug 11 02:23:15 2015 
357000 Tue Aug 11 02:23:20 2015 
358000 Tue Aug 11 02:23:26 2015 
359000 Tue Aug 11 02:23:31 2015 
360000 Tue Aug 11 02:23:36 2015 
361000 Tue Aug 11 02:23:41 2015 
362000 Tue Aug 11 02:23:47 2015 
363000 Tue Aug 11 02:23:52 2015 
364000 Tue Aug 11 02:23:57 2015 
365000 Tue Aug 11 02:24:02 2015 
366000 Tue Aug 11 02:24:07 2015 
367000 Tue Aug 11 02:24:12 2015 
368000 Tue Aug 11 02:24:17 2015 
369000 Tue Aug 11 02:24:23 2015 
370000 Tue Aug 11 02:24:28 2015 
371000 Tue Aug 11 02:24:34 2015 
372000 Tue Aug 11 02:24:39 2015 
373000 Tue Aug 11 02:24:45 2015 
374000 Tue Aug 11 02:24:50 2015 
375000 Tue Aug 11 02:24:55 2015 
376000 Tue Aug 11 02:25:01 2015 
377000 Tue Aug 11 02:25:06 2015 
378000 Tue Aug 11 02:25:11 2015 
379000 Tue Aug 11 02:25:17 2015 
380000 Tue Aug 11 02:25:22 2015 
381000 Tue Aug 11 02:25:27 2015 
382000 Tue Aug 11 02:25:33 2015 
383000 Tue Aug 11 02:25:38 2015 
384000 Tue Aug 11 02:25:43 2015 
385000 Tue Aug 11 02:25:49 2015 
386000 Tue Aug 11 02:25:54 2015 
387000 Tue Aug 11 02:26:00 2015 
388000 Tue Aug 11 02:26:05 2015 
389000 Tue Aug 11 02:26:11 2015 
390000 Tue Aug 11 02:26:16 2015 
391000 Tue Aug 11 02:26:22 2015 
392000 Tue Aug 11 02:26:26 2015 
393000 Tue Aug 11 02:26:32 2015 
394000 Tue Aug 11 02:26:37 2015 
> 
> pdf("figures2/methylation_vs_batches_p-value.pdf", width=10.5, height=7)
> par(mfrow=c(2,3), mar=c(5,4,2,1), bty="n")
> hist(pM[,1], xlab="p-value", main="instituion")
> hist(pM[,2], xlab="p-value", main="plate")
> hist(pM[,3], xlab="p-value", main="age")
> 
> hist(pM[,4], xlab="p-value", main="PC1")
> hist(pM[,5], xlab="p-value", main="PC2")
> hist(pM[,6], xlab="p-value", main="PC3")
> 
> dev.off()
null device 
          1 
> 
> summary(pM)
       V1                  V2               V3                V4           
 Min.   :0.0000000   Min.   :0.0000   Min.   :0.00000   Min.   :0.0000003  
 1st Qu.:0.0000127   1st Qu.:0.0000   1st Qu.:0.04535   1st Qu.:0.3556914  
 Median :0.0490497   Median :0.0172   Median :0.23593   Median :0.5890329  
 Mean   :0.1921154   Mean   :0.1738   Mean   :0.32950   Mean   :0.5690897  
 3rd Qu.:0.3177789   3rd Qu.:0.2720   3rd Qu.:0.57377   3rd Qu.:0.7987897  
 Max.   :0.9999774   Max.   :1.0000   Max.   :1.00000   Max.   :0.9999975  
       V5               V6           
 Min.   :0.0000   Min.   :0.0000007  
 1st Qu.:0.3445   1st Qu.:0.1787600  
 Median :0.5773   Median :0.4183930  
 Mean   :0.5608   Mean   :0.4459420  
 3rd Qu.:0.7920   3rd Qu.:0.6994589  
 Max.   :1.0000   Max.   :0.9999953  
> 
> # ------------------------------------------------------------
> # Run PCA using methylation data, check possible outlier
> # these PCs do include many batch effect information
> # ------------------------------------------------------------
> 
> datR14Pr = rDatM - rowMeans(rDatM, na.rm=TRUE)
> 
> datR14Pr[is.na(datR14Pr)] = 0
> covdatR1 = t(datR14Pr) %*% datR14Pr / nrow(datR14Pr)
> dim(covdatR1)
[1] 405 405
> prdatR1  = eigen(covdatR1)
> 
> prdatR1$values[1:20]
 [1] 24.2590894 18.7061725  8.9684872  6.5634460  4.4703302  3.9243459
 [7]  2.6171230  2.5398413  2.2901344  2.1298388  1.7637470  1.6710873
[13]  1.4608276  1.3482550  1.2295316  1.1908612  1.1299597  1.0737226
[19]  1.0648169  0.9841692
> 
> PC1 =  prdatR1$vectors[,1]
> PC2 =  prdatR1$vectors[,2]
> PC3 =  prdatR1$vectors[,3]
> 
> pdf("figures2/methylation_PCs_mvalue_rm_institute_plate_age_genoPC.pdf",
+ width=6, height=6)
> par(mar=c(5,4,1,1), mfrow=c(2,2))
> barplot(prdatR1$values[1:20], main="",
+ xlab="Index", ylab="Eigen-value")
> 
> subtypes = unique(na.omit(emInfo$pam50))
> cols = c("red", "green", "blue", "purple", "orange")
> 
> legend("topright", legend=subtypes, col=cols, pch=1, bty="n")
> 
> par(mar=c(5,4,1,1))
> 
> plot(PC1, PC2,  bty="n", cex=0.8)
> for(j in 1:5){
+   sj = subtypes[j]
+   wj = which(emInfo$pam50 == sj)
+   points(PC1[wj], PC2[wj], col=cols[j], cex=0.8)
+ }
> 
> plot(PC1, PC3,  bty="n", cex=0.8)
> for(j in 1:5){
+   sj = subtypes[j]
+   wj = which(emInfo$pam50 == sj)
+   points(PC1[wj], PC3[wj], col=cols[j], cex=0.8)
+ }
> 
> plot(PC2, PC3,  bty="n", cex=0.8)
> for(j in 1:5){
+   sj = subtypes[j]
+   wj = which(emInfo$pam50 == sj)
+   points(PC2[wj], PC3[wj], col=cols[j], cex=0.8)
+ }
> 
> dev.off()
null device 
          1 
> 
> cor(prdatR1$vectors[,1:5], emInfo$absolute_extract_purity, use="pair")
              [,1]          [,2]          [,3]          [,4]          [,5]
[1,]  1.000000e+00  1.555105e-15  8.880082e-17 -2.286283e-16  1.800486e-16
[2,]  1.555105e-15  1.000000e+00  9.607578e-17  1.027436e-16 -6.298777e-17
[3,]  8.880082e-17  9.607578e-17  1.000000e+00 -4.166841e-16  1.596873e-16
[4,] -2.286283e-16  1.027436e-16 -4.166841e-16  1.000000e+00 -6.651589e-16
[5,]  1.800486e-16 -6.298777e-17  1.596873e-16 -6.651589e-16  1.000000e+00
> 
> summary(lm(PC1 ~ emInfo$pam50))

Call:
lm(formula = PC1 ~ emInfo$pam50)

Residuals:
      Min        1Q    Median        3Q       Max 
-0.137083 -0.028868 -0.001363  0.030476  0.190810 

Coefficients:
                    Estimate Std. Error t value Pr(>|t|)    
(Intercept)        -0.031426   0.006031  -5.211 3.02e-07 ***
emInfo$pam50Her2    0.034747   0.012062   2.881  0.00418 ** 
emInfo$pam50LumA    0.036553   0.006833   5.349 1.49e-07 ***
emInfo$pam50LumB    0.042062   0.007846   5.361 1.40e-07 ***
emInfo$pam50Normal  0.006941   0.017967   0.386  0.69948    
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 0.04787 on 400 degrees of freedom
Multiple R-squared:  0.08338,	Adjusted R-squared:  0.07421 
F-statistic: 9.096 on 4 and 400 DF,  p-value: 4.848e-07

> summary(lm(PC2 ~ emInfo$pam50))

Call:
lm(formula = PC2 ~ emInfo$pam50)

Residuals:
      Min        1Q    Median        3Q       Max 
-0.106233 -0.025419 -0.001636  0.024706  0.154024 

Coefficients:
                    Estimate Std. Error t value Pr(>|t|)    
(Intercept)        -0.069978   0.004655 -15.032  < 2e-16 ***
emInfo$pam50Her2    0.048274   0.009311   5.185 3.44e-07 ***
emInfo$pam50LumA    0.080318   0.005275  15.227  < 2e-16 ***
emInfo$pam50LumB    0.102253   0.006056  16.884  < 2e-16 ***
emInfo$pam50Normal  0.023978   0.013869   1.729   0.0846 .  
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 0.03695 on 400 degrees of freedom
Multiple R-squared:  0.4539,	Adjusted R-squared:  0.4484 
F-statistic:  83.1 on 4 and 400 DF,  p-value: < 2.2e-16

> summary(lm(PC3 ~ emInfo$pam50))

Call:
lm(formula = PC3 ~ emInfo$pam50)

Residuals:
      Min        1Q    Median        3Q       Max 
-0.134476 -0.030983  0.002119  0.030467  0.124366 

Coefficients:
                    Estimate Std. Error t value Pr(>|t|)    
(Intercept)         0.024401   0.005766   4.232 2.87e-05 ***
emInfo$pam50Her2    0.015420   0.011531   1.337    0.182    
emInfo$pam50LumA   -0.041923   0.006533  -6.418 3.92e-10 ***
emInfo$pam50LumB   -0.008753   0.007500  -1.167    0.244    
emInfo$pam50Normal -0.012838   0.017176  -0.747    0.455    
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 0.04576 on 400 degrees of freedom
Multiple R-squared:  0.1623,	Adjusted R-squared:  0.1539 
F-statistic: 19.38 on 4 and 400 DF,  p-value: 1.38e-14

> 
> # ------------------------------------------------------------
> # Run clustreing on methylation data, check possible outlier
> # ------------------------------------------------------------
> 
> cr1   = cor(rDatM, use="pair")
> summary(as.numeric(cr1))
     Min.   1st Qu.    Median      Mean   3rd Qu.      Max. 
-0.526200 -0.098140 -0.007521  0.000955  0.087840  1.000000 
> 
> dist1 = as.dist(1 - cr1)
> h1 = hclust(dist1)
> 
> pdf("figures2/methylation_hclust_mvalue_rm_institute_plate_age_genoPC.pdf",
+     width=8, height=4)
> par(mar=c(5,4,1,1))
> plot(h1, main="", labels=FALSE, cex=0.7)
> 
> for(j in 1:5){
+   sj = subtypes[j]
+   wj = which(emInfo$pam50[h1$order] == sj)
+   mtext("I", side=1, line=0, col=cols[j], at=wj, cex=1, font=2)
+ }
> 
> legend("topright", legend=subtypes, col=cols, pch="I", bty="n", cex=0.9)
> dev.off()
null device 
          1 
> 
> # if the median correaltion of one sample with other samples is too low
> # indicating this sample is an outlier and we shoudl remove it
> 
> Ds = apply(cr1, 1, median)
> pdf("figures2/methylation_D_statistics_rm_institute_plate_age_genoPC.pdf",
+     width=8, height=4)
> par(mar=c(5,4,1,1), mfrow=c(1,2), bty="n")
> hist(Ds, xlab="D statistics", breaks=20, main="")
> plot(Ds, emInfo$absolute_extract_purity, type="n", ylab="Purity")
> 
> for(j in 1:5){
+   sj = subtypes[j]
+   wj = which(emInfo$pam50 == sj)
+   points(Ds[wj], emInfo$absolute_extract_purity[wj], col=cols[j], cex=0.8)
+ }
> dev.off()
null device 
          1 
> 
> emInfo$Ds = Ds
> emInfo[emInfo$Ds < quantile(Ds, 0.05), c(1:2,20:22)]
    bcr_patient_barcode patient_id abs_doublings  pam50     noHM_PC1
38         TCGA-A2-A1G1       A1G1             1  Basal -0.010180027
114        TCGA-AR-A1AJ       A1AJ             0  Basal -0.013365537
132        TCGA-AR-A24Q       A24Q             1  Basal -0.020344373
141        TCGA-AR-A251       A251             1  Basal  0.167430029
170        TCGA-B6-A1KF       A1KF             1  Basal -0.005863918
176        TCGA-BH-A0B3       A0B3             1  Basal -0.013398303
195        TCGA-BH-A0E0       A0E0             1  Basal -0.004693527
211        TCGA-BH-A0RX       A0RX             1  Basal  0.162269126
215        TCGA-BH-A0WA       A0WA             1  Basal -0.008103475
271        TCGA-D8-A1XF       A1XF             1   LumB -0.012823399
283        TCGA-D8-A1XW       A1XW             1 Normal -0.012738417
289        TCGA-D8-A27F       A27F             0  Basal -0.020600794
295        TCGA-D8-A27M       A27M             0  Basal -0.019532242
311        TCGA-E2-A15K       A15K             0   LumB -0.010467539
322        TCGA-E2-A1II       A1II             0  Basal  0.179685259
331        TCGA-E2-A1LH       A1LH             1  Basal  0.003828921
332        TCGA-E2-A1LI       A1LI             2  Basal -0.010522954
367        TCGA-E9-A22G       A22G             0  Basal -0.018963177
379        TCGA-E9-A3Q9       A3Q9             0   LumA -0.001550667
392        TCGA-EW-A1PH       A1PH             1  Basal -0.006877971
395        TCGA-GM-A2DA       A2DA             0   LumA -0.004989167
> 
> 
> q(save = "no")
> proc.time()
    user   system  elapsed 
5898.741  183.967 6393.099 
